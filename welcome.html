<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="Junior" content="width=device-width, initial-scale=1" />
  <title>DJ Gig Tracker ‚Ä¢ Notion Embed Widget</title>
  <style>
    :root{
      --bg:#0f1115;--card:#151923;--muted:#9aa4b2;--text:#e6e9ef;--accent:#7c5cff;--accent-2:#22c55e;--warn:#f59e0b;--danger:#ef4444;--border:#232838;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(124,92,255,.12);color:#d8d1ff;font-size:12px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 24px rgba(0,0,0,.24);overflow:hidden}
    .card .head{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--border)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls input[type="date"], .controls input[type="text"], .controls select{
      background:#0c0f15;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;outline:none;font-size:13px;min-height:36px
    }
    .controls .btn{appearance:none;border:none;background:var(--accent);color:white;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer;font-size:13px}
    .controls .btn.secondary{background:#1f2432;color:var(--text);border:1px solid var(--border)}
    .controls .btn.ghost{background:transparent;border:1px dashed var(--border)}

    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:rgba(10,12,18,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:12px;color:var(--muted);font-weight:700}
    tbody td{border-bottom:1px solid var(--border);padding:10px;font-size:14px;vertical-align:top}
    tbody tr:hover{background:#121622}

    .tag{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .tag.paid{background:rgba(34,197,94,.12);color:#b2f5c8;border-color:rgba(34,197,94,.35)}
    .tag.collab{background:rgba(245,158,11,.12);color:#ffe1a6;border-color:rgba(245,158,11,.35)}
    .tag.tba{background:rgba(124,92,255,.12);color:#e2d9ff;border-color:rgba(124,92,255,.35)}

    .row-actions{display:flex;gap:8px}
    .icon-btn{background:#1f2432;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:6px 8px;font-size:12px;cursor:pointer}
    .icon-btn.warn{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.35)}
    .icon-btn:disabled{opacity:.5;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .grid .field{display:flex;flex-direction:column;gap:6px}
    .grid label{font-size:12px;color:var(--muted)}

    .footer{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--border)}
    .muted{color:var(--muted)}
    a{color:#a5b4fc}
    .hidden{display:none}
    .hint{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:8px 0}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr 1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üéõÔ∏è DJ Gig Tracker</h1>
      <span class="badge" title="Persists in your browser via localStorage">Embed-ready ‚Ä¢ Local save</span>
    </header>

    <!-- Add / Edit Form -->
    <div class="card" id="formCard" aria-label="Add or edit gig">
      <div class="head">
        <strong>New Gig</strong>
        <div class="controls">
          <button class="btn secondary" id="clearFormBtn" type="button">Clear</button>
          <button class="btn" id="saveGigBtn" type="button">Add Gig</button>
        </div>
      </div>
      <div class="body" style="padding:14px">
        <div class="grid">
          <div class="field">
            <label for="date">Date</label>
            <input type="date" id="date" />
          </div>
          <div class="field">
            <label for="name">Event Name</label>
            <input type="text" id="name" placeholder="Party at The Loft" />
          </div>
          <div class="field">
            <label for="location">Event Location</label>
            <input type="text" id="location" placeholder="The Loft, Melbourne" />
          </div>
          <div class="field">
            <label for="setTimes">Set Times</label>
            <input type="text" id="setTimes" placeholder="10:00 PM ‚Äì 1:00 AM" />
          </div>
          <div class="field">
            <label for="type">Paid / Collab</label>
            <select id="type">
              <option value="Paid">Paid</option>
              <option value="Collab">Collab</option>
              <option value="TBA">TBA</option>
            </select>
          </div>
          <div class="field">
            <label for="notes">Notes / Links</label>
            <input type="text" id="notes" placeholder="Ticket link or promoter handle" />
          </div>
        </div>
        <input type="hidden" id="editingId" />
        <div class="hint" style="margin-top:8px">Tip: You can edit later from the table below. All data auto-saves to this page on your device.</div>
      </div>
    </div>

    <div style="height:12px"></div>

    <!-- List / Filters -->
    <div class="card" aria-label="Gig list">
      <div class="head">
        <div class="controls">
          <input type="text" id="search" placeholder="Search name, venue, city‚Ä¶" />
          <select id="filterType" title="Filter by type">
            <option value="all">All Types</option>
            <option value="Paid">Paid</option>
            <option value="Collab">Collab</option>
            <option value="TBA">TBA</option>
          </select>
          <select id="filterWhen" title="Filter by time">
            <option value="upcoming">Upcoming</option>
            <option value="past">Past</option>
            <option value="all">All dates</option>
          </select>
          <input type="date" id="fromDate" title="From" />
          <input type="date" id="toDate" title="To" />
          <button class="btn secondary" id="resetFilters">Reset</button>
        </div>
        <div class="controls">
          <button class="btn ghost" id="exportJSON">Export JSON</button>
          <button class="btn ghost" id="importJSON">Import JSON</button>
          <button class="btn ghost" id="exportCSV">Export CSV</button>
          <button class="btn ghost" id="exportICS">Export ICS</button>
          <button class="btn" id="seedData">Seed demo</button>
        </div>
      </div>

      <div class="table-wrap">
        <table role="table" aria-describedby="tableHelp">
          <thead>
            <tr>
              <th>Date</th>
              <th>Event Name</th>
              <th>Event Location</th>
              <th>Set Times</th>
              <th>Paid / Collab</th>
              <th>Notes / Links</th>
              <th style="width:120px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="footer">
        <div id="count" class="muted">0 gigs</div>
        <div class="controls">
          <div id="tableHelp" class="hint">Sorted by date. Click Edit to modify a row or Delete to remove it.</div>
          <button class="btn secondary" id="clearAll">Clear All Gigs</button>
        </div>
      </div>
        <div id="tableHelp" class="hint">Sorted by date. Click Edit to modify a row or Delete to remove it.</div>
      </div>
    </div>

    <p class="hint" style="margin-top:12px">Embedding in Notion: host this file (GitHub Pages/Netlify/Vercel), then paste the deployed URL into a Notion <em>/embed</em> block. Data is saved per-domain via localStorage.</p>
  </div>

  <input type="file" id="filePicker" accept="application/json" class="hidden" />

  <script>
    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const storageKey = 'djGigWidgetData:v1';

    const fmtDate = (iso) => {
      if(!iso) return '';
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
    };

    const todayISO = () => new Date().toISOString().slice(0,10);

    function uid(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36)
    }

    function saveAll(rows){
      localStorage.setItem(storageKey, JSON.stringify(rows));
    }
    function loadAll(){
      try{ return JSON.parse(localStorage.getItem(storageKey) || '[]') }catch{ return [] }
    }

    function toCSV(rows){
      const esc = (s='') => '"' + String(s).replaceAll('"','""') + '"';
      const header = ['date','name','location','setTimes','type','notes','id'];
      const lines = [header.join(',')].concat(rows.map(r=>[r.date,r.name,r.location,r.setTimes,r.type,r.notes,r.id].map(esc).join(',')));
      return lines.join('\n');
    }

    function download(filename, content, type='text/plain'){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    function toICS(rows){
      const lines = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//DJ Gig Widget//EN'
      ];
      rows.forEach(r=>{
        if(!r.date) return;
        const dt = r.date.replaceAll('-','');
        const uidLine = (r.id||uid()) + '@djwidget';
        const title = (r.name||'DJ Gig');
        const loc = (r.location||'');
        const desc = 'Set: ' + (r.setTimes||'') + ' | ' + (r.type||'');
        lines.push('BEGIN:VEVENT');
        lines.push('UID:'+uidLine);
        lines.push('DTSTAMP:'+dt+'T000000Z');
        lines.push('DTSTART;VALUE=DATE:'+dt);
        lines.push('SUMMARY:'+title.replace(/\n/g,' '));
        if(loc) lines.push('LOCATION:'+loc.replace(/\n/g,' '));
        if(desc) lines.push('DESCRIPTION:'+desc.replace(/\n/g,' '));
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      return lines.join('\n');
    }

    // ===== State =====
    let state = loadAll();

    // ===== Rendering =====
    function render(){
      const tbody = $('#rows');
      tbody.innerHTML = '';

      let list = [...state];
      // Filters
      const q = $('#search').value.trim().toLowerCase();
      if(q){
        list = list.filter(r => [r.name,r.location,r.notes].some(x=>String(x||'').toLowerCase().includes(q)));
      }
      const t = $('#filterType').value;
      if(t!=='all') list = list.filter(r=> (r.type||'').toLowerCase() === t.toLowerCase());
      const when = $('#filterWhen').value;
      const today = todayISO();
      if(when==='upcoming') list = list.filter(r=>!r.date || r.date >= today);
      if(when==='past') list = list.filter(r=>r.date && r.date < today);
      const from = $('#fromDate').value; const to = $('#toDate').value;
      if(from) list = list.filter(r=>!r.date || r.date >= from);
      if(to) list = list.filter(r=>!r.date || r.date <= to);

      list.sort((a,b)=>String(a.date||'').localeCompare(String(b.date||'')));

      list.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(r.date)}</td>
          <td>${escapeHTML(r.name)}</td>
          <td>${escapeHTML(r.location)}</td>
          <td>${escapeHTML(r.setTimes)}</td>
          <td>${tagHTML(r.type)}</td>
          <td>${linkify(r.notes)}</td>
          <td>
            <div class="row-actions">
              <button class="icon-btn" data-act="edit" data-id="${r.id}">Edit</button>
              <button class="icon-btn warn" data-act="del" data-id="${r.id}">Delete</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      $('#count').textContent = `${list.length} gig${list.length===1?'':'s'}`;
    }

    function escapeHTML(s=''){return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))}
    function linkify(s=''){
      const str = String(s).trim();
      if(/^https?:\/\//i.test(str)) return `<a href="${escapeHTML(str)}" target="_blank" rel="noopener">Link</a>`;
      return escapeHTML(str);
    }
    function tagHTML(t='TBA'){
      const v = (t||'TBA').toLowerCase();
      const cls = v==='paid'?'paid':v==='collab'?'collab':'tba';
      const label = v==='paid'?'Paid':v==='collab'?'Collab':'TBA';
      return `<span class="tag ${cls}">${label}</span>`;
    }

    // ===== CRUD =====
    function clearForm(){
      $('#editingId').value = '';
      $('#date').value = '';
      $('#name').value = '';
      $('#location').value = '';
      $('#setTimes').value = '';
      $('#type').value = 'Paid';
      $('#notes').value = '';
      $('#saveGigBtn').textContent = 'Add Gig';
    }

    function formToObj(){
      return {
        id: $('#editingId').value || uid(),
        date: $('#date').value || '',
        name: $('#name').value.trim(),
        location: $('#location').value.trim(),
        setTimes: $('#setTimes').value.trim(),
        type: $('#type').value,
        notes: $('#notes').value.trim()
      };
    }

    function loadToForm(obj){
      $('#editingId').value = obj.id;
      $('#date').value = obj.date || '';
      $('#name').value = obj.name || '';
      $('#location').value = obj.location || '';
      $('#setTimes').value = obj.setTimes || '';
      $('#type').value = obj.type || 'TBA';
      $('#notes').value = obj.notes || '';
      $('#saveGigBtn').textContent = 'Save Changes';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function upsert(obj){
      const i = state.findIndex(x=>x.id===obj.id);
      if(i>-1) state[i]=obj; else state.push(obj);
      saveAll(state); render();
    }

    function remove(id){
      state = state.filter(x=>x.id!==id);
      saveAll(state); render();
    }

    // ===== Seed Demo =====
    function seed(){
      const demo = [
        {date:'2025-09-05',name:'Loft Sessions',location:'The Loft, Melbourne',setTimes:'22:00‚Äì01:00',type:'Paid',notes:'https://tix.link/loft',id:uid()},
        {date:'2025-09-12',name:'Basement Bounce',location:'Basement Club, Melbourne',setTimes:'21:00‚Äì00:00',type:'Collab',notes:'@promoter_benji',id:uid()},
        {date:'2025-10-03',name:'Spring Wave',location:'Eden Rooftop, Sydney',setTimes:'23:00‚Äì02:00',type:'Paid',notes:'https://tix.link/springwave',id:uid()},
        {date:'2025-11-15',name:'Night Market Fest',location:'Queen Vic Market, Melbourne',setTimes:'20:00‚Äì23:00',type:'Collab',notes:'Main stage B2B',id:uid()},
        {date:'2025-12-20',name:'Summer Close-Out',location:'Warehouse 19, Melbourne',setTimes:'22:00‚Äì01:00',type:'Paid',notes:'https://tix.link/closeout',id:uid()},
      ];
      state = demo; saveAll(state); render();
    }

    // ===== Event Listeners =====
    $('#saveGigBtn').addEventListener('click', ()=>{
      const o = formToObj();
      if(!o.name){ alert('Event Name is required'); return }
      upsert(o); clearForm();
    });

    $('#clearFormBtn').addEventListener('click', clearForm);

    $('#rows').addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const id = btn.getAttribute('data-id');
      const item = state.find(x=>x.id===id);
      if(btn.dataset.act==='edit') loadToForm(item);
      if(btn.dataset.act==='del'){
        if(confirm('Delete this gig?')) remove(id);
      }
    });

    $$('#search, #filterType, #filterWhen, #fromDate, #toDate').forEach(el=>{
      el.addEventListener('input', render);
      el.addEventListener('change', render);
    });

    $('#resetFilters').addEventListener('click', ()=>{
      $('#search').value=''; $('#filterType').value='all'; $('#filterWhen').value='upcoming';
      $('#fromDate').value=''; $('#toDate').value=''; render();
    });

    // Export / Import
    $('#exportJSON').addEventListener('click', ()=>{
      download('dj-gigs.json', JSON.stringify(state, null, 2), 'application/json');
    });
    $('#exportCSV').addEventListener('click', ()=>{
      download('dj-gigs.csv', toCSV(state), 'text/csv');
    });
    $('#exportICS').addEventListener('click', ()=>{
      download('dj-gigs.ics', toICS(state), 'text/calendar');
    });

    $('#importJSON').addEventListener('click', ()=> $('#filePicker').click());
    $('#filePicker').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Invalid file');
        // Basic shape guard
        state = arr.map(x=>({
          id: x.id || uid(),
          date: x.date || '',
          name: x.name || '',
          location: x.location || '',
          setTimes: x.setTimes || '',
          type: x.type||'TBA',
          notes: x.notes||''
        }));
        saveAll(state); render();
      }catch(err){ alert('Import failed: ' + err.message) }
      e.target.value='';
    });

    $('#seedData').addEventListener('click', seed);

    // Initial
    if(state.length===0){ seed(); }
    render();
      // Clear All button
    const clearAllBtn = document.getElementById('clearAll');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', () => {
        if (confirm('This will remove ALL gigs from this device. You can\'t undo. Continue?')) {
          state = [];
          saveAll(state);
          clearForm();
          render();
        }
      });
    }

  </script>
</body>
</html>
